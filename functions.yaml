# functions.yaml

# --- I2C Bus Configuration for SSD1306 ---
i2c:
  id: i2c_bus_display
  sda: GPIO16
  scl: GPIO17
  scan: true

font:
  - file: "gfonts://Roboto"
    id: display_font
    size: 8
    glyphs:
      - '0123456789.,Â°'
      - 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
      - 'abcdefghijklmnopqrstuvwxyz'
      - ' /()|-:'

display:
  - platform: ssd1306_i2c
    id: pico_display
    model: "SSD1306 128x64"
    i2c_id: i2c_bus_display
    address: 0x3C

    lambda: |-
      #define LINE_HEIGHT_PIXELS 9

      #define print_line_normal(line_num, format, ...) \
        it.printf(0, (line_num - 1) * LINE_HEIGHT_PIXELS, id(display_font), COLOR_ON, format, ##__VA_ARGS__)

      #define print_line_inverse(line_num, format, ...) \
        do { \
          uint8_t y_pos = (line_num - 1) * LINE_HEIGHT_PIXELS; \
          it.filled_rectangle(0, y_pos, 128, LINE_HEIGHT_PIXELS, COLOR_ON); \
          it.printf(0, y_pos, id(display_font), COLOR_OFF, format, ##__VA_ARGS__); \
        } while(0)

      float temp_c = id(pico_chip_temperature).state;
      float batt_v = id(battery_voltage).state;

      // Helper for clean ON/OFF strings
      auto to_s = [](bool state) -> const char* { return state ? "ON" : "OFF"; };

      // Line 1: IP & Temp
      print_line_inverse(1, "IP: %s  %.1fC", id(ip_address_sensor).state.c_str(), temp_c);

      // Line 2: Battery & Armed
      print_line_normal(2, "Batt: %.1fV  Armed: %s", batt_v, to_s(id(armed).state));

      // Line 3: Main Power & Phases
      print_line_normal(3, "Main: %s  P1: %s  P2: %s", 
        to_s(id(mains).state), 
        to_s(id(gen_phase_1).state), 
        to_s(id(gen_phase_2).state));

      // Line 4: Control Logic
      print_line_normal(4, "Run: %s  Xfer: %s  Strt: %s", 
        to_s(id(run_enabled).state), 
        to_s(id(xfer_sw).state), 
        to_s(id(starting).state));

      // Line 5: Engine Faults 1
      print_line_normal(5, "LoOil: %s  OvrT: %s", 
        to_s(id(low_oil).state), 
        to_s(id(over_temp).state));

      // Line 6: Engine Faults 2
      print_line_normal(6, "OvrC: %s  OvrS: %s", 
        to_s(id(over_crank).state), 
        to_s(id(over_speed).state));

      // Line 7: Logic Status (Bottom Line)
      print_line_inverse(7, "STATE: %s  Alm: %s", 
        id(generator_status).state.c_str(), 
        to_s(id(alarm_status).state));
