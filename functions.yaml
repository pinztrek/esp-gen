# functions.yaml

# --- I2C Bus Configuration for SSD1306 ---
i2c:
  id: i2c_bus_display
  sda: GPIO4 
  scl: GPIO5
  scan: true

# --- Internal Font Definition ---
font:
  - platform: arial
    id: display_font

# --- SSD1306 Display Component ---
display:
  - platform: ssd1306_i2c
    id: pico_display
    
    model: "SSD1306 128x64"
    
    i2c_id: i2c_bus_display
    address: 0x3C
    
    # Define Constants/Macros for Abstraction
    lambda: |-
      #define LINE_HEIGHT_PIXELS 7 // Adjusted for tighter fit on 64px display
      
      // Macro that prints text starting at Y = (line_num - 1) * LINE_HEIGHT_PIXELS
      #define print_line(line_num, format, ...) \
        it.printf(0, (line_num - 1) * LINE_HEIGHT_PIXELS, id(display_font), format, ##__VA_ARGS__)
        
      // --- Helper Functions ---
      // Function to return ON/OFF string for display
      const char* bool_to_str(bool state) {
        return state ? "ON" : "OFF";
      }

      // --- Calculations ---
      float temp_c = id(pico_chip_temperature).state;
      float batt_v = id(battery_voltage).state;
      
      // --- Display Calls using the Macro (Max 9 lines fit cleanly with 7px spacing) ---
      
      // Line 1: IP Address
      print_line(1, "IP: %s", id(ip_address_sensor).state.c_str());
      
      // Line 2: Temperature
      print_line(2, "Pico Temp: %.1f C", temp_c);
      
      // Line 3: Battery Voltage & Armed Status
      print_line(3, "Batt: %.2fV | Armed: %s", batt_v, bool_to_str(id(armed).state));
      
      // Line 4: Run Enabled & Starting 
      print_line(4, "Run: %s | Start: %s", bool_to_str(id(run_enabled).state), bool_to_str(id(starting).state));
      
      // Line 5: Mains Status & Alarm 
      print_line(5, "Mains: %s | Alarm: %s", bool_to_str(id(mains).state), bool_to_str(id(alarm).state));
      
      // Line 6: Low Oil / Overtemp 
      print_line(6, "LoOil: %s | OverT: %s", bool_to_str(id(low_oil).state), bool_to_str(id(over_temp).state));
      
      // Line 7: Overcrank / Overspeed 
      print_line(7, "OvrCrank: %s | OvrSpd: %s", bool_to_str(id(over_crank).state), bool_to_str(id(over_speed).state));
      
      // Line 8: Generator Phase Status
      print_line(8, "P1: %s | P2: %s", bool_to_str(id(gen_phase_1).state), bool_to_str(id(gen_phase_2).state));

      // Line 9: MQTT Connection Status (Updated)
      if (id(mqtt).is_connected()) {
        print_line(9, "MQTT: 192.168.1.5");
      } else {
        print_line(9, "MQTT Disconnected");
      }
