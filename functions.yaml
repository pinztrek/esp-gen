# functions.yaml

# --- I2C Bus Configuration for SSD1306 ---
i2c:
  id: i2c_bus_display
  sda: GPIO16 
  scl: GPIO17 
  scan: true

# --- Font Definition (Uses Google Fonts for minimal dependency) ---
font:
  - file: "gfonts://Roboto" # ESPHome downloads this at compile time
    id: display_font
    size: 8 # <--- FONT SIZE SET TO 8
    glyphs:
      # Consolidated glyph list (no duplicates)
      - '0123456789.,°'
      - 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
      - 'abcdefghijklmnopqrstuvwxyz'
      - ' /()|-:'

# --- SSD1306 Display Component ---
display:
  - platform: ssd1306_i2c
    id: pico_display
    
    model: "SSD1306 128x64"
    
    i2c_id: i2c_bus_display
    address: 0x3C
    
    # Define Constants, Macros, and the Display Logic
    lambda: |-
      // --- MACRO DEFINITIONS ---
      #define LINE_HEIGHT_PIXELS 9 // <--- LINE HEIGHT SET TO 9
      
      // Macro that prints text starting at Y = (line_num - 1) * LINE_HEIGHT_PIXELS
      #define print_line(line_num, format, ...) \
        it.printf(0, (line_num - 1) * LINE_HEIGHT_PIXELS, id(display_font), format, ##__VA_ARGS__)
        
      // --- Calculations ---
      float temp_c = id(pico_chip_temperature).state;
      float batt_v = id(battery_voltage).state;
      
      // --- Display Calls (Max 7 lines fit with 9px spacing) ---
      
      // Line 1: IP Address & Pico Temperature (xx.x °C)
      print_line(1, "IP: %s | %.1f °C", id(ip_address_sensor).state.c_str(), temp_c);
      
      // Line 2: Battery Voltage & Armed Status
      print_line(2, "Batt: %.2fV | Armed: %s", 
        batt_v, 
        id(armed).state ? "ON" : "OFF"
      );
      
      // Line 3: Mains & Generator Phase Status
      print_line(3, "Mains: %s | P1: %s P2: %s", 
        id(mains).state ? "ON" : "OFF",
        id(gen_phase_1).state ? "ON" : "OFF",
        id(gen_phase_2).state ? "ON" : "OFF"
      );
      
      // Line 4: Control Status (Run Enabled & Starting)
      print_line(4, "Run: %s | Start: %s", 
        id(run_enabled).state ? "ON" : "OFF",
        id(starting).state ? "ON" : "OFF"
      );

      // Line 5: Low Oil / Overtemp
      print_line(5, "LoOil: %s | OverT: %s", 
        id(low_oil).state ? "ON" : "OFF",
        id(over_temp).state ? "ON" : "OFF"
      );
      
      // Line 6: Overcrank / Overspeed
      print_line(6, "OvrCrank: %s | OvrSpd: %s", 
        id(over_crank).state ? "ON" : "OFF",
        id(over_speed).state ? "ON" : "OFF"
      );
      
      // Line 7: Alarm Status & MQTT Status Placeholder
      print_line(7, "Alarm: %s | MQTT: Disabled", 
        id(alarm_status).state ? "ON" : "OFF"
      );
